name: Rust CI

on:
    push:
        branches:
            - main
        paths:
            - 'backend/**'
    pull_request:
        branches:
            - main
        paths:
            - 'backend/**'

jobs:
    # --- 1. Formatting Check Job ---
    format:
        name: Check formatting
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: backend
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            # Install the Rust toolchain (stable is sufficient for formatting)
            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: stable
                  # Install the 'rustfmt' component explicitly
                  components: rustfmt

            # Run the formatting check. If any file is not formatted, this command will fail.
            - name: Run cargo fmt --check
              run: cargo fmt -- --check

    # --- 2. Security Audit Job ---
    audit:
        name: Security audit
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Check for Cargo file changes
              uses: dorny/paths-filter@v3
              id: changes
              with:
                  filters: |
                      cargo:
                        - 'backend/Cargo.toml'
                        - 'backend/Cargo.lock'

            - name: Run cargo audit
              if: steps.changes.outputs.cargo == 'true' || github.event_name == 'push'
              uses: rustsec/audit-check@v2.0.0
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  working-directory: backend

    # --- 3. Test Job ---
    test:
        name: Test on Rust ${{ matrix.rust }}
        runs-on: ubuntu-latest
        # Tests run after format and audit checks pass
        needs: [format, audit]
        defaults:
            run:
                working-directory: backend

        strategy:
            matrix:
                rust:
                    - stable
                    # - beta

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ matrix.rust }}

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Run cargo test
              run: cargo test --verbose

            - name: Run cargo clippy
              run: cargo clippy -- -D warnings
